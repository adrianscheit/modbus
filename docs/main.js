(()=>{"use strict";var t,e,r,n=document.querySelector("h2.error").appendChild(document.createTextNode("")),o=function(t){console.error(t);var e="Error: ".concat(t);n.nodeValue=e,u([new s(I(),!0),new s(""),new s(""),new s(e,!0)])},a=document.querySelector("fieldset"),i=function(t){a.disabled=t},s=function(t,e){void 0===e&&(e=!1),this.td=document.createElement("td"),this.td.appendChild(document.createTextNode(t)),e&&this.td.classList.add("error"),this.csvText="".concat("".concat(t).replace(/[\n\r]/gm,"").replace(/,/gm,";"),",")},c=[],l=document.querySelector("tbody"),u=function(t){var e=document.createElement("tr");t.forEach((function(t){return e.appendChild(t.td)})),l.insertBefore(e,l.firstChild),l.childElementCount>1e3&&l.removeChild(l.lastChild),c.unshift(t.map((function(t){return t.csvText})).join(""))},f=function(t){return document.querySelector("input[type=checkbox][name=".concat(t,"]")).checked},h=function(t,e){return t[e]<<8^t[e+1]},d=function(t){if(4!==t.length)throw new Error("Invalid data format for AddressQuantity!");this.address=h(t,0),this.quantity=h(t,2)},m=function(){function t(e){if(e[0]!==e.length-1)throw new Error("Invalid data format for Booleans!");this.onOff=e.slice(1).flatMap((function(e){return t.bitsInByte.map((function(t){return!!(t&e)}))}))}return t.bitsInByte=[128,64,32,16,8,4,2,1],t}(),p=function(){function t(t){if(t[0]!==t.length-1||0!=(1&t[0]))throw new Error("Invalid data format for Registers!");var e=new DataView(new Uint8Array(t).buffer);this.createEmptyArrayIfValid(e,"Uint",1),this.createEmptyArrayIfValid(e,"Int",1),this.createEmptyArrayIfValid(e,"Uint",2),this.createEmptyArrayIfValid(e,"Int",2),this.createEmptyArrayIfValid(e,"Uint",4),this.createEmptyArrayIfValid(e,"Int",4),this.createEmptyArrayIfValid(e,"Float",4),this.createEmptyArrayIfValid(e,"Float",8)}return t.prototype.createEmptyArrayIfValid=function(t,e,r){var n="".concat(e).concat(8*r);if(f(n)){for(var o="get".concat(n),a=[],i=1;i<=t.byteLength-r;i+=r)a.push(t[o](i,!1));this[n]=a}},t}(),y=function(t){if(4!==t.length)throw new Error("Invalid data format for WriteSingleBoolean!");if(this.address=h(t,0),0===t[2]&&0===t[3])this.onOff=!1;else{if(!(255===t[2]&&0===t[3]||0===t[2]&&255===t[3]))throw new Error("Invalid data format for single register... Allowed only: 0xFF00, 0x00FF, 0x0000");this.onOff=!0}},v=function(t){if(4!==t.length)throw new Error("Invalid data format for AddressData!");this.address=h(t,0),this.data=h(t,2)},w={1:{fromMasterToSlave:d,fromSlaveToMaster:m},2:{fromMasterToSlave:d,fromSlaveToMaster:m},3:{fromMasterToSlave:d,fromSlaveToMaster:p},4:{fromMasterToSlave:d,fromSlaveToMaster:p},5:{fromMasterToSlave:y,fromSlaveToMaster:y},6:{fromMasterToSlave:v,fromSlaveToMaster:v},15:{fromMasterToSlave:function(t){if(t.length<=4)throw new Error("Invalid data format for AddressQuantityBooleans!");this.addressQuantity=new d(t.slice(0,4)),this.booleans=new m(t.slice(4))},fromSlaveToMaster:d},16:{fromMasterToSlave:function(t){if(t.length<=4)throw new Error("Invalid data format for AddressQuantityRegisters!");this.addressQuantity=new d(t.slice(0,4)),this.registers=new p(t.slice(4))},fromSlaveToMaster:d}},g=function(){function t(t){this.data=t,this.slaveAddress=t.shift(),this.functionCode=t.shift();var e=w[this.functionCode];if(e){try{this.fromMasterToSlave=new e.fromMasterToSlave(t)}catch(t){this.fromMasterToSlaveError=this.getError(t)}try{this.fromSlaveToMaster=new e.fromSlaveToMaster(t)}catch(t){this.fromSlaveToMasterError=this.getError(t)}}}return t.prototype.isNoValidDataFormat=function(){return!!this.fromMasterToSlaveError&&!!this.fromSlaveToMasterError},t.prototype.getError=function(t){return"".concat(t.message)},t}(),S={1:"Read Coils",2:"Read Discrete Inputs",3:"Read Holding Registers",4:"Read Input Registers",5:"Write Single Coil",6:"Write Single Register",7:"Read Status",8:"Diagnostic Test",15:"Write Multiple Coils",16:"Write Multiple Registers",17:"Identify Device Server"},E={129:"Illegal Function",130:"Illegal Data Address",131:"Illegal Data Value",132:"Server Device Failure",133:"Acknowledge",134:"Server Device Busy",135:"Negative Acknowledge",136:"Memory Parity Error",144:"Gateway Path Unavailable",145:"Gateway Target Device Failed to Respond"},b=function(t){return null==t?"".concat(t):"0x".concat(t<16?"0":"").concat(t.toString(16))},T=(t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)},function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}),I=function(){var t=new Date;return"".concat(t.toLocaleString(),"+").concat(t.getMilliseconds(),"ms")},M=function(t){return t.map((function(t){return b(t)})).join(" ")},A=function(t){var e,r=[I(),"".concat(t.slaveAddress),"".concat(t.functionCode),(e=t.functionCode,128&e?E[e]||"Unknown error ".concat(b(e)):S[e]||"Unknown function ".concat(b(e))),"".concat(t.data.length)].map((function(t){return new s(t,!1)}));t.isNoValidDataFormat()?[t.fromMasterToSlaveError,t.fromSlaveToMasterError].forEach((function(e){return r.push(new s("".concat(e," ").concat(M(t.data)),!0))})):[t.fromMasterToSlave,t.fromSlaveToMaster].forEach((function(t){return r.push(new s(JSON.stringify(t,void 0,2)))})),u(r)},C=function(t){u([I(),"","","","","",M(t)].map((function(t){return new s(t,!0)})))},B=function(){function t(){}return t.prototype.receive=function(t){},t}(),x=function(){function t(t){this.byte=t,this.crc=65535}return t.prototype.updateCrc=function(t){this.crc^=t;for(var e=0;e<8;++e){var r=1&this.crc;this.crc>>=1,r&&(this.crc^=40961)}return 0===this.crc},t}(),D=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.history=[],e}return T(e,t),e.prototype.receive=function(e){var r=this;t.prototype.receive.call(this,e),this.timeoutHandler&&clearTimeout(this.timeoutHandler),this.timeoutHandler=setTimeout((function(){return r.resetFrame()}),300),e.forEach((function(t){r.history.push(new x(t));for(var e=0;e<r.history.length;++e)if(r.history[e].updateCrc(t)){var n=r.history.map((function(t){return t.byte})),o=new g(n.slice(e,-2));if(f("onlyValid")&&(r.history.length<4||o.isNoValidDataFormat())){console.warn("Found end of frame (i=".concat(e,") but the data field seems invalid!"),o);continue}e&&C(n.slice(0,e)),A(o),r.history=[],clearTimeout(r.timeoutHandler);break}r.history.length>300&&console.warn("Rejecteding because history bigger than 300",r.history.shift())}))},e.prototype.resetFrame=function(){console.warn("timeout"),C(this.history.map((function(t){return t.byte}))),this.history=[]},e}(B),F=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.frameChars=[],e.frameBytes=[],e.currentLrc=0,e}return T(e,t),e.prototype.receive=function(e){var r=this;for(t.prototype.receive.call(this,e),e.forEach((function(t){return r.frameChars.push(t)}));this.frameChars.length>=2;){var n=this.frameChars.shift();if(58===n)this.resetFrame();else{var o=this.frameChars.shift();if(58===o)this.resetFrame();else if(13===n&&10===o)this.frameBytes.pop(),isNaN(this.currentLrc)||0!=(255&this.currentLrc)?C(this.frameBytes):A(new g(this.frameBytes)),this.frameBytes=[],this.currentLrc=0;else{var a=parseInt(String.fromCharCode(n,o),16);this.frameBytes.push(a),this.updateLrc(a)}}}},e.prototype.resetFrame=function(){this.frameBytes.length&&(C(this.frameBytes),this.frameBytes=[],this.currentLrc=0)},e.prototype.updateLrc=function(t){this.currentLrc+=t},e}(B),V=navigator.serial;V||(o("No serial support in this browser!"),i(!0)),null===(e=document.getElementById("clearSnifferButton"))||void 0===e||e.addEventListener("click",(function(){!function(){for(;l.lastChild;)l.removeChild(l.lastChild);for(;c.length;)c.pop()}()})),null===(r=document.getElementById("downloadSnifferButton"))||void 0===r||r.addEventListener("click",(function(){!function(){if(0!==c.length){var t=c.join("\r\n"),e=window.document.createElement("a");e.setAttribute("href","data:text/csv; charset=utf-8,"+encodeURIComponent("\ufeff"+t)),e.setAttribute("download","".concat(c[0].substring(0,20),"-").concat(c[c.length-1].substring(0,20),".csv")),e.click()}}()})),document.querySelector("form").addEventListener("submit",(function(t){t.preventDefault();var e=Object.fromEntries(function(t,e,r){if(r||2===arguments.length)for(var n,o=0,a=e.length;o<a;o++)!n&&o in e||(n||(n=Array.prototype.slice.call(e,0,o)),n[o]=e[o]);return t.concat(n||Array.prototype.slice.call(e))}([],t.target,!0).map((function(t){return[t.name,+t.value||t.value]})));console.log(e),k(e,"ASCII"===e.modbusmode?new F:new D)}));var k=function(t,e){V.requestPort().then((function(r){console.log("serialPort",r),r.open(t).then((function(){return t=void 0,a=void 0,c=function(){var t,a,s,c;return function(t,e){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(a){return function(s){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=e.call(t,i)}catch(t){a=[6,t],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,s])}}}(this,(function(l){switch(l.label){case 0:n.nodeValue="",i(!0),l.label=1;case 1:if(!r.readable)return[3,9];t=r.readable.getReader(),l.label=2;case 2:l.trys.push([2,6,7,8]),l.label=3;case 3:return[4,t.read()];case 4:return a=l.sent(),s=a.value,a.done?[3,5]:(e.receive(s),[3,3]);case 5:return[3,8];case 6:return c=l.sent(),o(c),[3,8];case 7:return t.releaseLock(),[7];case 8:return[3,1];case 9:return[4,r.close()];case 10:return l.sent(),i(!1),[2]}}))},new((s=void 0)||(s=Promise))((function(e,r){function n(t){try{i(c.next(t))}catch(t){r(t)}}function o(t){try{i(c.throw(t))}catch(t){r(t)}}function i(t){var r;t.done?e(t.value):(r=t.value,r instanceof s?r:new s((function(t){t(r)}))).then(n,o)}i((c=c.apply(t,a||[])).next())}));var t,a,s,c}),o)}),console.warn)};(new D).receive(new Uint8Array([17,34,51,68,85,4,1,0,10,0,13,221,152,255,255,17,34,51,68,85,17,15,0,19,0,10,2,205,1,191,11,1,3,8,65,32,0,0,66,200,0,0,228,111,1,16,15,163,0,2,4,0,20,7,208,187,154])),(new F).receive((new TextEncoder).encode("&*^&^%^%$*&&%%$#:0401000A000DE4\r\nxyz!@=$%#$;:0401000A0DE4\r\n:0401000A000D00\r\n"))})();