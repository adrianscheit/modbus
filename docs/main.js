(()=>{"use strict";var e,t=function(e,t){return e[t]<<8^e[t+1]},r=function(e){if(4!==e.length)throw new Error("Invalid data format for DataAddressQuantity! ".concat(JSON.stringify(e)));this.address=t(e,0),this.quantity=t(e,2)},n=function(){function e(t){if(t[0]!==t.length-1)throw new Error("Invalid data format for DataBooleans! ".concat(JSON.stringify(t)));this.onOff=t.slice(1).flatMap((function(t){return e.bitsInByte.map((function(e){return!!(e&t)}))}))}return e.bitsInByte=[128,64,32,16,8,4,2,1],e}(),a=function(e){if(this.uInt16=[],this.int16=[],e[0]!==e.length-1||0!=(1&e[0]))throw new Error("Invalid data format for DataRegisters! ".concat(JSON.stringify(e)));for(var t=new DataView(new Uint8Array(e).buffer),r=1;r<e.length;r+=2)this.uInt16.push(t.getUint16(r,!1)),this.int16.push(t.getInt16(r,!1));if(0==(3&e[0])&&e[0]>=4)for(this.float32=[],this.uInt32=[],this.int32=[],r=1;r<e.length;r+=4)this.float32.push(t.getFloat32(r,!1)),this.uInt32.push(t.getUint32(r,!1)),this.int32.push(t.getInt32(r,!1))},o=function(e){if(4!==e.length)throw new Error("Invalid data format for DataWriteSingleBoolean! ".concat(JSON.stringify(e)));if(this.address=t(e,0),0===e[2]&&0===e[3])this.onOff=!1;else{if(!(255===e[2]&&0===e[3]||0===e[2]&&255===e[3]))throw new Error("Invalid data format for single register... Allowed only: 0xFF00, 0x00FF, 0x0000");this.onOff=!0}},i=function(e){if(4!==e.length)throw new Error("Invalid data format for DataAddressData! ".concat(JSON.stringify(e)));this.address=t(e,0),this.data=t(e,2)},s={1:{fromMasterToSlave:r,fromSlaveToMaster:n},2:{fromMasterToSlave:r,fromSlaveToMaster:n},3:{fromMasterToSlave:r,fromSlaveToMaster:a},4:{fromMasterToSlave:r,fromSlaveToMaster:a},5:{fromMasterToSlave:o,fromSlaveToMaster:o},6:{fromMasterToSlave:i,fromSlaveToMaster:i},15:{fromMasterToSlave:function(e){if(e.length<=4)throw new Error("Invalid data format for DataAddressQuantityBooleans! ".concat(JSON.stringify(e)));this.dataAddressQuantity=new r(e.slice(0,4)),this.dataBooleans=new n(e.slice(4))},fromSlaveToMaster:r},16:{fromMasterToSlave:function(e){if(e.length<=4)throw new Error("Invalid data format for DataAddressQuantityRegisters! ".concat(JSON.stringify(e)));this.dataAddressQuantity=new r(e.slice(0,4)),this.dataRegisters=new a(e.slice(4))},fromSlaveToMaster:r}},c=function(e){this.data=e,this.slaveAddress=e.shift(),this.functionCode=e.shift();var t=s[this.functionCode];if(t){try{this.fromMasterToSlave=new t.fromMasterToSlave(e)}catch(e){this.fromMasterToSlave=e.message}try{this.fromSlaveToMaster=new t.fromSlaveToMaster(e)}catch(e){this.fromSlaveToMaster=e.message}}},l={1:"Read Coils",2:"Read Discrete Inputs",3:"Read Holding Registers",4:"Read Input Registers",5:"Write Single Coil",6:"Write Single Register",7:"Read Status",8:"Diagnostic Test",15:"Write Multiple Coils",16:"Write Multiple Registers",17:"Identify Device Server"},f={129:"Illegal Function",130:"Illegal Data Address",131:"Illegal Data Value",132:"Server Device Failure",133:"Acknowledge",134:"Server Device Busy",135:"Negative Acknowledge",136:"Memory Parity Error",144:"Gateway Path Unavailable",145:"Gateway Target Device Failed to Respond"},u=function(e){return"0x".concat(e<16?"0":"").concat(e.toString(16))},h=(e=function(t,r){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},e(t,r)},function(t,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function n(){this.constructor=t}e(t,r),t.prototype=null===r?Object.create(r):(n.prototype=r.prototype,new n)}),d=function(){function e(){this.snifferTable=document.querySelector("table")}return e.prototype.receive=function(e){},e.prototype.getItemElement=function(e,t){void 0===t&&(t=!1);var r=document.createElement("td");return r.appendChild(document.createTextNode(e)),t&&r.classList.add("error"),r},e.prototype.report=function(e,t){var r,n=this,a=document.createElement("tr"),o=new Date;["".concat(o.toLocaleTimeString(),"+").concat(o.getMilliseconds(),"ms"),"".concat(t.slaveAddress),"".concat(t.functionCode),(r=t.functionCode,128&r?f[r]||"Unknown error ".concat(u(r)):l[r]||"Unknown function ".concat(u(r)))].forEach((function(e){return a.appendChild(n.getItemElement(e))}));var i=[t.fromMasterToSlave,t.fromSlaveToMaster];"string"==typeof i[0]&&"string"==typeof i[1]?i.forEach((function(e){return a.appendChild(n.getItemElement(e,!0))})):i.forEach((function(e){return a.appendChild(n.getItemElement("object"==typeof e?JSON.stringify(e,void 0,1):""))})),e||a.classList.add("error"),this.snifferTable.appendChild(a)},e}(),p=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.frameBytes=[],t.currentCrc=65535,t}return h(t,e),t.prototype.receive=function(t){var r=this;e.prototype.receive.call(this,t),this.timeoutHandler&&clearTimeout(this.timeoutHandler),this.timeoutHandler=setTimeout((function(){return r.endFrame()}),120),t.forEach((function(e){r.frameBytes.push(e),r.updateCrc(e),0===r.currentCrc&&r.frameBytes.length>=4&&r.endFrame()}))},t.prototype.endFrame=function(){this.frameBytes.pop(),this.frameBytes.pop(),this.frameBytes.length&&(this.report(0===this.currentCrc,new c(this.frameBytes)),this.frameBytes=[],this.currentCrc=65535)},t.prototype.updateCrc=function(e){this.currentCrc^=e;for(var t=0;t<8;++t){var r=1&this.currentCrc;this.currentCrc>>=1,r&&(this.currentCrc^=40961)}},t}(d),m=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.frameChars=[],t.frameBytes=[],t.currentLrc=0,t}return h(t,e),t.prototype.receive=function(t){var r=this;for(e.prototype.receive.call(this,t),t.forEach((function(e){return r.frameChars.push(e)}));this.frameChars.length>=2;){var n=this.frameChars.shift();if(this.frameBytes.length,58===n)this.frameBytes.length&&this.endFrame();else{var a=this.frameChars.shift();if(13===n&&10===a)this.endFrame();else{var o=parseInt(String.fromCharCode(n,a),16);this.frameBytes.push(o),this.updateLrc(o)}}}},t.prototype.endFrame=function(){this.frameBytes.pop(),this.report(0===this.currentLrc,new c(this.frameBytes)),this.frameBytes=[],this.currentLrc=0},t.prototype.updateLrc=function(e){this.currentLrc+=e,this.currentLrc&=255},t}(d),v=document.querySelector("h2.error").appendChild(document.createTextNode("")),y=function(e){console.error(e),v.nodeValue="".concat(e)},g=document.querySelector("fieldset"),w=navigator.serial;w||(y("No serial support in this browser!"),g.disabled=!0),document.querySelector("form").addEventListener("submit",(function(e){e.preventDefault();var t=Object.fromEntries(function(e,t,r){if(r||2===arguments.length)for(var n,a=0,o=t.length;a<o;a++)!n&&a in t||(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))}([],e.target,!0).map((function(e){return[e.name,+e.value||e.value]})));console.log(t),S(t,"ASCII"===t.modbusmode?new m:new p)}));var S=function(e,t){w.requestPort().then((function(r){console.log("serialPort",r),r.open(e).then((function(){return e=void 0,n=void 0,o=function(){var e,n,a,o;return function(e,t){var r,n,a,o,i={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(a=2&o[0]?n.return:o[0]?n.throw||((a=n.return)&&a.call(n),0):n.next)&&!(a=a.call(n,o[1])).done)return a;switch(n=0,a&&(o=[2&o[0],a.value]),o[0]){case 0:case 1:a=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,n=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!((a=(a=i.trys).length>0&&a[a.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!a||o[1]>a[0]&&o[1]<a[3])){i.label=o[1];break}if(6===o[0]&&i.label<a[1]){i.label=a[1],a=o;break}if(a&&i.label<a[2]){i.label=a[2],i.ops.push(o);break}a[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],n=0}finally{r=a=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}(this,(function(i){switch(i.label){case 0:v.nodeValue="",g.disabled=!0,i.label=1;case 1:if(!r.readable)return[3,9];e=r.readable.getReader(),i.label=2;case 2:i.trys.push([2,6,7,8]),i.label=3;case 3:return[4,e.read()];case 4:return n=i.sent(),a=n.value,n.done?[3,5]:(t.receive(a),[3,3]);case 5:return[3,8];case 6:return o=i.sent(),y(o),[3,8];case 7:return e.releaseLock(),[7];case 8:return[3,1];case 9:return[4,r.close()];case 10:return i.sent(),g.disabled=!1,[2]}}))},new((a=void 0)||(a=Promise))((function(t,r){function i(e){try{c(o.next(e))}catch(e){r(e)}}function s(e){try{c(o.throw(e))}catch(e){r(e)}}function c(e){var r;e.done?t(e.value):(r=e.value,r instanceof a?r:new a((function(e){e(r)}))).then(i,s)}c((o=o.apply(e,n||[])).next())}));var e,n,a,o}),y)}),console.warn)},b=new p;b.receive(new Uint8Array([4,1,0,10,0,13,221,152])),b.receive(new Uint8Array([17,15,0,19,0,10,2,205,1,191,11])),b.receive(new Uint8Array([1,3,8,65,32,0,0,66,200,0,0,228,111])),b.receive(new Uint8Array([1,16,15,163,0,2,4,0,20,7,208,187,154]));var T=new m;T.receive((new TextEncoder).encode(":0401000A000DE4\r\n")),T.receive((new TextEncoder).encode(":0401000A000D00\r\n"))})();